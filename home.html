<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Практика</title>
    <style>
        body {
            background: #202124;
            color: #bdc1c6;
            font-family: Open Sans, Noto Sans, Roboto;
            margin: auto;
            padding-top: 20px;
            width: 50%;
        }

        a {
            cursor: pointer;
        }

        li {

            list-style: none;
        }

        #preview {
            max-width: 100%;
        }
    </style>
</head>

<body>
    <div>
        <form name="publish">
            <input type="text" name="message">
            <input type="submit" value="Search">
            <label>Made with ❤️ </label>
        </form>
        <ul id="results"></ul>
        <h2>Downloaded Content</h2>
        <ul id="downloaded"></ul>
        <div><img id="preview"></div>
    </div>


    <script>
        const results = document.getElementById('results')
        const wsp = window.location.host.includes('localhost') ? 'ws' : 'wss'
        let socket = new WebSocket(wsp + '://' + window.location.host)
        // Клиент посылает ключевое слово на сервер
        document.forms.publish.onsubmit = (ee) => {
            socket.send(ee.target[0].value)
            return false
        };
        socket.onmessage = (event) => {
            const urls = JSON.parse(event.data)
            results.innerHTML = urls.length == 0 ? 'Zero results. Try keywords: people, world' : ''
            for (let url of urls) {
                url = window.location.origin + url
                const li = document.createElement('li')
                const a = document.createElement('a')
                const span = document.createElement('span')
                a.innerHTML = url
                a.onclick = () => { downloadContent(span, url) }
                li.append(a)
                li.append(span)
                results.append(li)
            }
        };
        socket.onerror = (exp) => {
            results.innerHTML = '  No connection to the WebWocket. Try to reload the page.'
        };
        socket.onclose = (exp) => {
            results.innerHTML = '  The connection to WebSocket is closed. Try to reload the page.'
        };
        // 
        function downloadContent(span, url) {
            if (!localStorage[url]) {
                downloadContent2Storage(url, span)
            }
        }
        function displayContent(url) {
            const content = localStorage[url]
            const preview = document.getElementById('preview')
            preview.src = content
        }
        // показ списка загруженного контента с возможностью выбора контента
        function listDownloadedContent() {
            // возможностью чтения оффлайн
            const downloaded = document.getElementById('downloaded')
            downloaded.innerHTML = ''
            for (const url in localStorage) {
                if (!Object.hasOwnProperty.call(localStorage, url)) {
                    continue
                }
                const li = document.createElement('li')
                const a = document.createElement('a')
                a.innerText = url
                a.onclick = () => { displayContent(url) }
                li.append(a)
                downloaded.append(li)
            }
        }
        function downloadContent2Storage(url, span) {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'blob'
            let size, threads
            xhr.onreadystatechange = () => {
                if (xhr.readyState === xhr.HEADERS_RECEIVED) {
                    threads = xhr.getResponseHeader("Threads")
                    size = xhr.getResponseHeader("Content-Length")
                    if (!threads) {
                        span.innerHTML = '  Wait a free thread, 10 sec'
                        xhr.abort()
                    }
                }
            };
            xhr.onprogress = (event) => {
                if (event.lengthComputable) {
                    const progress = (100 * event.loaded / event.total).toFixed(0)
                    span.innerHTML = `  { Threads: ${threads},  Size: ${event.total},  Progress: ${progress} % }`
                }
            };
            xhr.onload = (event) => {
                const fr = new FileReader();
                fr.onload = () => {
                    localStorage[url] = fr.result
                    listDownloadedContent()
                };
                fr.readAsDataURL(xhr.response)
            };
            xhr.onerror = (exp) => {
                span.innerHTML = '  Content was not downloaded. Try to reload the page.'
            };
            xhr.send()
        }
        // возможностью чтения оффлайн.
        listDownloadedContent()

        function remove() {
            localStorage.clear()
            listDownloadedContent()
        }
        // document.forms.publish.insertAdjacentHTML('beforeend', `<input type="button" value="Remove downloaded" onclick="remove()">`)
    </script>
</body>

</html>